dag:
  repository: moj-analytical-services/data_linking
  tag: v5.0.0.dev6
  retries: 0
  retry_delay: 150
  max_active_runs: 1

  tasks:
    # -----------------------
    # MAGS DEDUPE JOB (baseline ~20m)
    # -----------------------
    source_nodes_mags_hocas:
      compute_profile: general-spot-1vcpu-4gb
      env_vars:
        PIPELINE_STAGE: source_nodes
        PIPELINE_DATASET: mags_hocas
        PIPELINE_VERSION: dev

    standardised_nodes_mags_hocas:
      compute_profile: general-spot-32vcpu-128gb
      env_vars:
        PIPELINE_STAGE: standardised_nodes
        PIPELINE_DATASET: mags_hocas
        PIPELINE_VERSION: dev
      dependencies: [source_nodes_mags_hocas]

    model_training_mags_hocas:
      compute_profile: general-spot-64vcpu-256gb
      env_vars:
        PIPELINE_STAGE: model_training
        PIPELINE_DATASET: mags_hocas
        PIPELINE_VERSION: dev
      dependencies: [standardised_nodes_mags_hocas]

    edge_generation_mags_hocas:
      compute_profile: general-spot-64vcpu-256gb
      env_vars:
        PIPELINE_STAGE: edge_generation
        PIPELINE_DATASET: mags_hocas
        PIPELINE_VERSION: dev
      dependencies: [model_training_mags_hocas]

    # -----------------------
    # XHIBIT DEDUPE JOB (~1m)
    # -----------------------
    source_nodes_crown_xhibit:
      compute_profile: general-spot-1vcpu-4gb
      env_vars:
        PIPELINE_STAGE: source_nodes
        PIPELINE_DATASET: crown_xhibit
        PIPELINE_VERSION: dev

    standardised_nodes_crown_xhibit:
      compute_profile: general-spot-4vcpu-16gb
      env_vars:
        PIPELINE_STAGE: standardised_nodes
        PIPELINE_DATASET: crown_xhibit
        PIPELINE_VERSION: dev
      dependencies: [source_nodes_crown_xhibit]

    model_training_crown_xhibit:
      compute_profile: general-spot-8vcpu-32gb
      env_vars:
        PIPELINE_STAGE: model_training
        PIPELINE_DATASET: crown_xhibit
        PIPELINE_VERSION: dev
      dependencies: [standardised_nodes_crown_xhibit]

    edge_generation_crown_xhibit:
      compute_profile: general-spot-8vcpu-32gb
      env_vars:
        PIPELINE_STAGE: edge_generation
        PIPELINE_DATASET: crown_xhibit
        PIPELINE_VERSION: dev
      dependencies: [model_training_crown_xhibit]

    # -----------------------
    # COMMON PLATFORM DEDUPE JOB (~4m)
    # -----------------------
    source_nodes_common_platform:
      compute_profile: general-spot-1vcpu-4gb
      env_vars:
        PIPELINE_STAGE: source_nodes
        PIPELINE_DATASET: common_platform
        PIPELINE_VERSION: dev

    standardised_nodes_common_platform:
      compute_profile: general-spot-8vcpu-32gb
      env_vars:
        PIPELINE_STAGE: standardised_nodes
        PIPELINE_DATASET: common_platform
        PIPELINE_VERSION: dev
      dependencies: [source_nodes_common_platform]

    model_training_common_platform:
      compute_profile: general-spot-16vcpu-64gb
      env_vars:
        PIPELINE_STAGE: model_training
        PIPELINE_DATASET: common_platform
        PIPELINE_VERSION: dev
      dependencies: [standardised_nodes_common_platform]

    edge_generation_common_platform:
      compute_profile: general-spot-16vcpu-64gb
      env_vars:
        PIPELINE_STAGE: edge_generation
        PIPELINE_DATASET: common_platform
        PIPELINE_VERSION: dev
      dependencies: [model_training_common_platform]

    # -----------------------
    # NOMIS DEDUPE JOB (~2.3m)
    # -----------------------
    source_nodes_prison_nomis:
      compute_profile: general-spot-1vcpu-4gb
      env_vars:
        PIPELINE_STAGE: source_nodes
        PIPELINE_DATASET: prison_nomis
        PIPELINE_VERSION: dev

    standardised_nodes_prison_nomis:
      compute_profile: general-spot-8vcpu-32gb
      env_vars:
        PIPELINE_STAGE: standardised_nodes
        PIPELINE_DATASET: prison_nomis
        PIPELINE_VERSION: dev
      dependencies: [source_nodes_prison_nomis]

    model_training_prison_nomis:
      compute_profile: general-spot-16vcpu-64gb
      env_vars:
        PIPELINE_STAGE: model_training
        PIPELINE_DATASET: prison_nomis
        PIPELINE_VERSION: dev
      dependencies: [standardised_nodes_prison_nomis]

    edge_generation_prison_nomis:
      compute_profile: general-spot-16vcpu-64gb
      env_vars:
        PIPELINE_STAGE: edge_generation
        PIPELINE_DATASET: prison_nomis
        PIPELINE_VERSION: dev
      dependencies: [model_training_prison_nomis]

    # -----------------------
    # OASYS DEDUPE JOB (~2m)
    # -----------------------
    source_nodes_prison_oasys:
      compute_profile: general-spot-1vcpu-4gb
      env_vars:
        PIPELINE_STAGE: source_nodes
        PIPELINE_DATASET: prison_oasys
        PIPELINE_VERSION: dev

    standardised_nodes_prison_oasys:
      compute_profile: general-spot-8vcpu-32gb
      env_vars:
        PIPELINE_STAGE: standardised_nodes
        PIPELINE_DATASET: prison_oasys
        PIPELINE_VERSION: dev
      dependencies: [source_nodes_prison_oasys]

    model_training_prison_oasys:
      compute_profile: general-spot-16vcpu-64gb
      env_vars:
        PIPELINE_STAGE: model_training
        PIPELINE_DATASET: prison_oasys
        PIPELINE_VERSION: dev
      dependencies: [standardised_nodes_prison_oasys]

    edge_generation_prison_oasys:
      compute_profile: general-spot-16vcpu-64gb
      env_vars:
        PIPELINE_STAGE: edge_generation
        PIPELINE_DATASET: prison_oasys
        PIPELINE_VERSION: dev
      dependencies: [model_training_prison_oasys]

    # -----------------------
    # DELIUS DEDUPE JOB (~2.5m)
    # -----------------------
    source_nodes_probation_delius:
      compute_profile: general-spot-1vcpu-4gb
      env_vars:
        PIPELINE_STAGE: source_nodes
        PIPELINE_DATASET: probation_delius
        PIPELINE_VERSION: dev

    standardised_nodes_probation_delius:
      compute_profile: general-spot-8vcpu-32gb
      env_vars:
        PIPELINE_STAGE: standardised_nodes
        PIPELINE_DATASET: probation_delius
        PIPELINE_VERSION: dev
      dependencies: [source_nodes_probation_delius]

    model_training_probation_delius:
      compute_profile: general-spot-16vcpu-64gb
      env_vars:
        PIPELINE_STAGE: model_training
        PIPELINE_DATASET: probation_delius
        PIPELINE_VERSION: dev
      dependencies: [standardised_nodes_probation_delius]

    edge_generation_probation_delius:
      compute_profile: general-spot-16vcpu-64gb
      env_vars:
        PIPELINE_STAGE: edge_generation
        PIPELINE_DATASET: probation_delius
        PIPELINE_VERSION: dev
      dependencies: [model_training_probation_delius]

iam:
  athena: write
  s3_read_only:
    - alpha-mojap-curated-mags/*
    - alpha-mojap-curated-xhibit/*
    - alpha-nomis/*
    - alpha-mojap-curated-open-data/*
    - moj-analytics-lookup-tables/*
    - moj-analytics-s3-logs/alpha-data-linking/*
    - moj-analytics-s3-logs/alpha-data-linking-anonymised/*
    - mojap-derived-tables/prod/*
    - alpha-mojap-common-platform/dev*/database/*
    - alpha-mojap-derived-family/*
    - alpha-mojap-civil/*
    - alpha-geography/prod/*/curated/*
    - alpha-enforcement-data-engineering/db_v2/live/*

  s3_read_write:
    - alpha-data-linking/*
    - alpha-data-linking-anonymised/*

maintainers:
  - ThomasHepworth
  - samnlindsay

tags:
  business_unit: Central Digital
  owner: thomas.hepworth@justice.gov.uk
