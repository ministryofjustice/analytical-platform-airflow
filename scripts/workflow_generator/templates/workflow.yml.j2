{{ meta.project }}.{{ meta.workflow }}:
  default_args:
    depends_on_past: {{ dag.depends_on_past|default(False) }}
    {%- if dag.end_date %}
    end_date: {{ dag.end_date }}
    {% endif %}
    owner: {{ tags.owner }}
    retries: {{ dag.retries|default(0) }}
    {%- if dag.retry_delay %}
    retry_delay: { "seconds": {{ dag.retry_delay|default(300) }} }
    {%- endif %}
    start_date: {{ dag.start_date|default("2025-01-01") }}
  catchup: {{ dag.catchup|default(False) }}
  is_paused_upon_creation: {{ dag.is_paused_upon_creation|default(False) }}
  max_active_runs: {{ dag.max_active_runs|default(1) }}
  {%- if dag.schedule_interval %}
  schedule_interval: {{ dag.schedule_interval }}
  {%- endif %}
  tasks:
    {%- if dag.tasks %}
    {%- for task_name, task in dag.tasks.items() %}
    {{ task_name }}:
      operator: analytical_platform.standard_operator.AnalyticalPlatformStandardOperator
      name: {{ meta.project }}-{{ meta.workflow }}-{{ task_name }}
      task_id: {{ meta.project }}-{{ meta.workflow }}-{{ task_name }}
      compute_profile: {{ task.compute_profile or dag.compute_profile or "general-spot-1vcpu-4gb" }}
      image: 509399598587.dkr.ecr.eu-west-2.amazonaws.com/{{ dag.repository }}:{{ dag.tag }}
      {%- if task.env_vars %}
      env_vars:
        {%- for k, v in task.env_vars.items() %}
        {{ k }}: {{ v }}
        {%- endfor %}
      {%- endif %}
      {%- if secrets %}
      secrets: {{ secrets }}
      {%- endif %}
      environment: {{ meta.environment }}
      project: {{ meta.project }}
      workflow: {{ meta.workflow }}
      {%- if task.dependencies %}
      dependencies: {{ task.dependencies }}
      {%- endif %}
    {%- endfor %}
    {%- else %}
    main:
      operator: analytical_platform.standard_operator.AnalyticalPlatformStandardOperator
      name: {{ meta.project }}.{{ meta.workflow }}
      task_id: {{ meta.project }}-{{ meta.workflow }}
      compute_profile: {{ dag.compute_profile|default("general-spot-1vcpu-4gb") }}
      image: 509399598587.dkr.ecr.eu-west-2.amazonaws.com/{{ dag.repository }}:{{ dag.tag }}
      {%- if dag.env_vars %}
      env_vars:
        {%- for k, v in dag.env_vars.items() %}
        {{ k }}: {{ v }}
        {%- endfor %}
      {%- endif %}
      {%- if secrets %}
      secrets: {{ secrets }}
      {%- endif %}
      environment: {{ meta.environment }}
      project: {{ meta.project }}
      workflow: {{ meta.workflow }}
    {%- endif %}
