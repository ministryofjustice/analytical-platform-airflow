from datetime import datetime

from airflow import DAG
from airflow.exceptions import AirflowFailException
from airflow.decorators import task
from airflow.models import Variable
from airflow.providers.cncf.kubernetes.operators.kubernetes_pod import (
    KubernetesPodOperator,
)
from kubernetes.client import models as k8s_models

# TODO - Review eval() function, should be bool() instead, but bool("False") returns True - go figure...
maintenance_window_active = eval(
    Variable.get("MAINTENANCE_WINDOW_ACTIVE", default_var="False")
)

default_args = {
    "owner": "{{ tags.owner }}",
    "depends_on_past": False,
    "email_on_failure": True,
    "start_date": datetime(2020, 1, 1),
}

dag = DAG(
    dag_id="{{ project }}.{{ workflow }}",
    max_active_tasks=1,
    schedule_interval=None,
    default_args=default_args,
)


@task(
    task_id="maintenance-window-check",
    default_args={"owner": "{{ tags.owner }}"},
)
def maintenance_window_check():
    print(maintenance_window_active)
    if maintenance_window_active:
        raise AirflowFailException(
            "There is an active maintenance window. Please try again later."
        )
    else:
        pass


maintenance_check = maintenance_window_check()

task = KubernetesPodOperator(
    dag=dag,
    task_id="{{ project }}-{{ workflow }}",
    namespace="airflow",
    name="{{ project }}-{{ workflow }}",
    image="{{ image.repository }}:{{ image.tag }}",
    cmds=["sleep", "300"],
    annotations={"karpenter.sh/do-not-disrupt": "true"},
    labels={
        "airflow.compute.analytical-platform.service.justice.gov.uk/environment": "{{ environment }}",
        "airflow.compute.analytical-platform.service.justice.gov.uk/project": "{{ project }}",
        "airflow.compute.analytical-platform.service.justice.gov.uk/workflow": "{{ workflow }}",
    },
    affinity={
        "nodeAffinity": {
            "requiredDuringSchedulingIgnoredDuringExecution": {
                "nodeSelectorTerms": [
                    {
                        "matchExpressions": [
                            {
                                "key": "compute.analytical-platform.service.justice.gov.uk/karpenter-node-pool",
                                "operator": "In",
                                "values": ["{{ compute[0].karpenter_node_pool }}"],
                            }
                        ]
                    }
                ]
            }
        }
    },
    tolerations=[
        {
            "key": "compute.analytical-platform.service.justice.gov.uk/karpenter-node-pool",
            "operator": "Equal",
            "value": "{{ compute[0].karpenter_node_pool }}",
            "effect": "NoSchedule",
        }
    ],
    container_resources=k8s_models.V1ResourceRequirements(
        requests={{ compute[0].container_resources.requests }},
        limits={{ compute[0].container_resources.limits }},
    ),
    security_context={
        "runAsNonRoot": True,
        "runAsUser": 1000,
        # This needs to go somewhere else
        # "allowPrivilegeEscalation": False,
        "privileged": False,
    },
    # Commented out while not using real IAM
    # service_account_name="{{ project }}-{{ workflow }}",
    in_cluster=False,
    get_logs=True,
    startup_timeout_seconds=600,
    is_delete_operator_pod=True,
    config_file="/usr/local/airflow/dags/.kube/config",
)

task << maintenance_check
